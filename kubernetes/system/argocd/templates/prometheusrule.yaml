apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: argocd-alerts
  namespace: {{ .Release.Namespace }}
spec:
  groups:
    - name: argocd.application
      rules:
        - alert: ArgoCDAppUnhealthy
          expr: |
            argocd_app_info{health_status!="Healthy",health_status!="Progressing"} == 1
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "ArgoCD application {{ `{{ $labels.name }}` }} is unhealthy"
            description: "Application {{ `{{ $labels.name }}` }} has health status {{ `{{ $labels.health_status }}` }} for more than 15 minutes."

        - alert: ArgoCDAppOutOfSync
          expr: |
            argocd_app_info{sync_status="OutOfSync"} == 1
          for: 30m
          labels:
            severity: warning
          annotations:
            summary: "ArgoCD application {{ `{{ $labels.name }}` }} is out of sync"
            description: "Application {{ `{{ $labels.name }}` }} has been OutOfSync for more than 30 minutes."

        - alert: ArgoCDAppSyncFailed
          expr: |
            increase(argocd_app_sync_total{phase!="Succeeded"}[10m]) > 3
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "ArgoCD application {{ `{{ $labels.name }}` }} sync is failing"
            description: "Application {{ `{{ $labels.name }}` }} has failed to sync more than 3 times in the last 10 minutes."

        - alert: ArgoCDAppMissing
          expr: |
            argocd_app_info{health_status="Missing"} == 1
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "ArgoCD application {{ `{{ $labels.name }}` }} resources are missing"
            description: "Application {{ `{{ $labels.name }}` }} has missing resources for more than 5 minutes."
