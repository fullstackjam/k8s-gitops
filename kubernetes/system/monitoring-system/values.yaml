kube-prometheus-stack:
  grafana:
    enabled: false
    forceDeployDatasources: true
    forceDeployDashboards: true
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://loki.loki:3100
  prometheus:
    prometheusSpec:
      ruleSelectorNilUsesHelmValues: false
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelectorNilUsesHelmValues: false
      probeSelectorNilUsesHelmValues: false
      volumes:
        - name: etcd-certs
          hostPath:
            path: /etc/ssl/etcd/ssl
            type: Directory
      volumeMounts:
        - name: etcd-certs
          mountPath: /etc/ssl/etcd/ssl
          readOnly: true
  alertmanager:
    alertmanagerSpec:
      containers:
        - name: ntfy-relay
          image: ghcr.io/khuedoan/webhook-transformer:v0.0.3
          args:
            - --port=8081
            - --config=/config/alertmanager-to-ntfy.jsonnet
            - --upstream-host=https://ntfy.sh
          envFrom:
            - secretRef:
                name: webhook-transformer
          volumeMounts:
            - name: config
              mountPath: /config
      volumes:
        - name: config
          configMap:
            name: webhook-transformer
    config:
      route:
        receiver: ntfy
        group_by:
          - namespace
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 12h
        routes:
          - receiver: ntfy
            matchers:
              - alertname = "Watchdog"
      receivers:
        - name: ntfy
          webhook_configs:
            - url: http://localhost:8081
              send_resolved: true

  defaultRules:
    rules:
      kubeProxy: false # Disable kube-proxy rules as we are using Cilium

  kubeEtcd:
    enabled: true
    endpoints:
      - 192.168.2.55
      - 192.168.2.56
      - 192.168.2.57
    service:
      enabled: true
      port: 2379
      targetPort: 2379
    serviceMonitor:
      scheme: https
      insecureSkipVerify: false
      serverName: localhost
      caFile: /etc/ssl/etcd/ssl/ca.pem
      certFile: /etc/ssl/etcd/ssl/node-homelab-5.pem
      keyFile: /etc/ssl/etcd/ssl/node-homelab-5-key.pem
