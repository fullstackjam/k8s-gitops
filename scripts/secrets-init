#!/bin/sh
set -e

# 1Password vault and item names (customize these)
OP_VAULT="${OP_VAULT:-Private}"
OP_KUBECONFIG_ITEM="${OP_KUBECONFIG_ITEM:-k8s-gitops-kubeconfig}"
OP_TERRAFORM_ITEM="${OP_TERRAFORM_ITEM:-k8s-gitops-terraform}"

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Check if 1Password CLI is installed
if ! command -v op >/dev/null 2>&1; then
    echo "Error: 1Password CLI (op) is not installed." >&2
    echo "Install it from: https://developer.1password.com/docs/cli/get-started/" >&2
    exit 1
fi

# Check if signed in
if ! op account get >/dev/null 2>&1; then
    echo "Error: Not signed in to 1Password. Run 'op signin' first." >&2
    exit 1
fi

echo "Fetching secrets from 1Password vault: $OP_VAULT"

# Fetch kubeconfig
echo "  -> metal/kubeconfig.yaml"
op document get "$OP_KUBECONFIG_ITEM" --vault="$OP_VAULT" > "$ROOT_DIR/metal/kubeconfig.yaml"
chmod 600 "$ROOT_DIR/metal/kubeconfig.yaml"

# Generate terraform.tfvars from 1Password fields
echo "  -> external/terraform.tfvars"
cat > "$ROOT_DIR/external/terraform.tfvars" << EOF
cloudflare_email      = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/cloudflare_email")"
cloudflare_api_key    = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/cloudflare_api_key")"
cloudflare_account_id = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/cloudflare_account_id")"

ntfy = {
  url   = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/ntfy_url")"
  topic = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/ntfy_topic")"
}

extra_secrets = {
$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/extra_secrets" 2>/dev/null || echo "  # No extra_secrets configured")
}
EOF
chmod 600 "$ROOT_DIR/external/terraform.tfvars"

echo "Done! Secrets initialized from 1Password."
