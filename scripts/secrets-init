#!/bin/sh
set -e

# 1Password vault and item names (customize these)
OP_VAULT="${OP_VAULT:-Private}"
OP_KUBECONFIG_ITEM="${OP_KUBECONFIG_ITEM:-k8s-gitops-kubeconfig}"
OP_TERRAFORM_ITEM="${OP_TERRAFORM_ITEM:-k8s-gitops-terraform}"

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"
HASH_FILE="$ROOT_DIR/.secrets.hash"

KUBECONFIG_PATH="$ROOT_DIR/metal/kubeconfig.yaml"
TFVARS_PATH="$ROOT_DIR/external/terraform.tfvars"

# Calculate hash of current local files
calculate_local_hash() {
    if [ -f "$KUBECONFIG_PATH" ] && [ -f "$TFVARS_PATH" ]; then
        cat "$KUBECONFIG_PATH" "$TFVARS_PATH" | shasum -a 256 | cut -d' ' -f1
    else
        echo "missing"
    fi
}

# Read stored hash
read_stored_hash() {
    if [ -f "$HASH_FILE" ]; then
        cat "$HASH_FILE"
    else
        echo "none"
    fi
}

# Check if refresh needed (unless forced with -f)
if [ "$1" != "-f" ]; then
    LOCAL_HASH=$(calculate_local_hash)
    STORED_HASH=$(read_stored_hash)
    
    if [ "$LOCAL_HASH" = "$STORED_HASH" ]; then
        # Files exist and match expected hash, skip
        exit 0
    fi
    
    if [ "$LOCAL_HASH" != "missing" ] && [ "$LOCAL_HASH" != "$STORED_HASH" ]; then
        echo "Warning: Local secrets modified, re-fetching from 1Password..." >&2
    fi
fi

# Check if 1Password CLI is installed
if ! command -v op >/dev/null 2>&1; then
    echo "Error: 1Password CLI (op) is not installed." >&2
    echo "Install it from: https://developer.1password.com/docs/cli/get-started/" >&2
    exit 1
fi

# Check if signed in
if ! op account get >/dev/null 2>&1; then
    echo "Error: Not signed in to 1Password. Run 'op signin' first." >&2
    exit 1
fi

echo "Fetching secrets from 1Password vault: $OP_VAULT"

# Fetch kubeconfig
echo "  -> metal/kubeconfig.yaml"
op document get "$OP_KUBECONFIG_ITEM" --vault="$OP_VAULT" > "$KUBECONFIG_PATH"
chmod 600 "$KUBECONFIG_PATH"

# Generate terraform.tfvars from 1Password fields
echo "  -> external/terraform.tfvars"
cat > "$TFVARS_PATH" << EOF
cloudflare_email      = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/cloudflare_email")"
cloudflare_api_key    = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/cloudflare_api_key")"
cloudflare_account_id = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/cloudflare_account_id")"

ntfy = {
  url   = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/ntfy_url")"
  topic = "$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/ntfy_topic")"
}

extra_secrets = {
$(op read "op://$OP_VAULT/$OP_TERRAFORM_ITEM/extra_secrets" 2>/dev/null || echo "  # No extra_secrets configured")
}
EOF
chmod 600 "$TFVARS_PATH"

# Store hash of fetched content
calculate_local_hash > "$HASH_FILE"

echo "Done! Secrets initialized from 1Password."
